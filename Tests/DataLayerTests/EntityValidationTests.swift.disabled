import XCTest
import CoreData
@testable import DataLayer

/// Tests for entity validation rules
final class EntityValidationTests: CoreDataTestBase {
    
    // MARK: - Project Validation Tests
    
    func testProjectNameValidation() throws {
        let project = Project(context: testContext)

        // Test empty name validation
        project.name = ""
        do {
            try project.validateForInsert()
            XCTFail("Expected validation error for empty name")
        } catch let error as ValidationError {
            XCTAssertEqual(error.localizedDescription, "Project name cannot be empty")
        }

        // Test valid name
        project.name = "Valid Project Name"
        XCTAssertNoThrow(try project.validateForInsert())
    }
    
    func testProjectTimestamps() throws {
        let project = createTestProject()
        try saveContext()
        
        XCTAssertNotNil(project.createdAt)
        XCTAssertNotNil(project.updatedAt)
        assertDatesEqual(project.createdAt, project.updatedAt)
        
        // Test that updatedAt changes when modified
        let originalUpdatedAt = project.updatedAt
        Thread.sleep(forTimeInterval: 0.1) // Small delay to ensure timestamp difference
        
        project.name = "Updated Name"
        try saveContext()
        
        XCTAssertNotNil(project.updatedAt)
        XCTAssertNotEqual(originalUpdatedAt, project.updatedAt)
    }
    
    // MARK: - Pattern Validation Tests
    
    func testPatternNameValidation() throws {
        let project = createTestProject()
        let pattern = Pattern(context: testContext)
        pattern.project = project
        
        // Test empty name validation
        pattern.name = ""
        assertValidationError(
            try pattern.validateValue(&pattern.name, forKey: "name"),
            expectedError: .invalidName("Pattern name cannot be empty or exceed 50 characters")
        )
        
        // Test name too long
        pattern.name = String(repeating: "a", count: 51)
        assertValidationError(
            try pattern.validateValue(&pattern.name, forKey: "name"),
            expectedError: .invalidName("Pattern name cannot be empty or exceed 50 characters")
        )
        
        // Test valid name
        pattern.name = "Valid Pattern"
        XCTAssertNoThrow(try pattern.validateValue(&pattern.name, forKey: "name"))
    }
    
    func testPatternLengthValidation() throws {
        let project = createTestProject()
        let pattern = Pattern(context: testContext)
        pattern.project = project
        pattern.name = "Test Pattern"
        
        // Test length too small
        var invalidLength: Int16 = 0
        assertValidationError(
            try pattern.validateValue(&invalidLength, forKey: "length"),
            expectedError: .invalidValue("Pattern length must be between 1 and 128 steps")
        )
        
        // Test length too large
        invalidLength = 129
        assertValidationError(
            try pattern.validateValue(&invalidLength, forKey: "length"),
            expectedError: .invalidValue("Pattern length must be between 1 and 128 steps")
        )
        
        // Test valid lengths
        for validLength: Int16 in [1, 16, 32, 64, 128] {
            var length = validLength
            XCTAssertNoThrow(try pattern.validateValue(&length, forKey: "length"))
        }
    }
    
    func testPatternTempoValidation() throws {
        let project = createTestProject()
        let pattern = Pattern(context: testContext)
        pattern.project = project
        pattern.name = "Test Pattern"
        
        // Test tempo too slow
        var invalidTempo: Double = 29.9
        assertValidationError(
            try pattern.validateValue(&invalidTempo, forKey: "tempo"),
            expectedError: .invalidValue("Pattern tempo must be between 30.0 and 300.0 BPM")
        )
        
        // Test tempo too fast
        invalidTempo = 300.1
        assertValidationError(
            try pattern.validateValue(&invalidTempo, forKey: "tempo"),
            expectedError: .invalidValue("Pattern tempo must be between 30.0 and 300.0 BPM")
        )
        
        // Test valid tempos
        for validTempo in [30.0, 60.0, 120.0, 180.0, 300.0] {
            var tempo = validTempo
            XCTAssertNoThrow(try pattern.validateValue(&tempo, forKey: "tempo"))
        }
    }
    
    // MARK: - Track Validation Tests
    
    func testTrackNameValidation() throws {
        let (_, pattern, _, _) = try createTestHierarchy()
        let track = Track(context: testContext)
        track.pattern = pattern
        
        // Test empty name validation
        track.name = ""
        assertValidationError(
            try track.validateValue(&track.name, forKey: "name"),
            expectedError: .invalidName("Track name cannot be empty")
        )
        
        // Test valid name
        track.name = "Valid Track"
        XCTAssertNoThrow(try track.validateValue(&track.name, forKey: "name"))
    }
    
    func testTrackVolumeValidation() throws {
        let (_, pattern, _, _) = try createTestHierarchy()
        let track = Track(context: testContext)
        track.pattern = pattern
        track.name = "Test Track"
        
        // Test volume too low
        var invalidVolume: Float = -0.1
        assertValidationError(
            try track.validateValue(&invalidVolume, forKey: "volume"),
            expectedError: .invalidValue("Track volume must be between 0.0 and 1.0")
        )
        
        // Test volume too high
        invalidVolume = 1.1
        assertValidationError(
            try track.validateValue(&invalidVolume, forKey: "volume"),
            expectedError: .invalidValue("Track volume must be between 0.0 and 1.0")
        )
        
        // Test valid volumes
        for validVolume: Float in [0.0, 0.5, 0.75, 1.0] {
            var volume = validVolume
            XCTAssertNoThrow(try track.validateValue(&volume, forKey: "volume"))
        }
    }
    
    func testTrackPanValidation() throws {
        let (_, pattern, _, _) = try createTestHierarchy()
        let track = Track(context: testContext)
        track.pattern = pattern
        track.name = "Test Track"
        
        // Test pan too low
        var invalidPan: Float = -1.1
        assertValidationError(
            try track.validateValue(&invalidPan, forKey: "pan"),
            expectedError: .invalidValue("Track pan must be between -1.0 and 1.0")
        )
        
        // Test pan too high
        invalidPan = 1.1
        assertValidationError(
            try track.validateValue(&invalidPan, forKey: "pan"),
            expectedError: .invalidValue("Track pan must be between -1.0 and 1.0")
        )
        
        // Test valid pan values
        for validPan: Float in [-1.0, -0.5, 0.0, 0.5, 1.0] {
            var pan = validPan
            XCTAssertNoThrow(try track.validateValue(&pan, forKey: "pan"))
        }
    }
    
    func testTrackIndexValidation() throws {
        let (_, pattern, _, _) = try createTestHierarchy()
        let track = Track(context: testContext)
        track.pattern = pattern
        track.name = "Test Track"
        
        // Test track index too low
        var invalidIndex: Int16 = -1
        assertValidationError(
            try track.validateValue(&invalidIndex, forKey: "trackIndex"),
            expectedError: .invalidValue("Track index must be between 0 and 15")
        )
        
        // Test track index too high
        invalidIndex = 16
        assertValidationError(
            try track.validateValue(&invalidIndex, forKey: "trackIndex"),
            expectedError: .invalidValue("Track index must be between 0 and 15")
        )
        
        // Test valid track indices
        for validIndex: Int16 in 0...15 {
            var index = validIndex
            XCTAssertNoThrow(try track.validateValue(&index, forKey: "trackIndex"))
        }
    }
    
    // MARK: - Trig Validation Tests
    
    func testTrigStepValidation() throws {
        let (_, _, track, _) = try createTestHierarchy()
        let trig = Trig(context: testContext)
        trig.track = track
        trig.pattern = track.pattern
        
        // Test step too low
        var invalidStep: Int16 = -1
        assertValidationError(
            try trig.validateValue(&invalidStep, forKey: "step"),
            expectedError: .invalidValue("Trig step must be between 0 and 127")
        )
        
        // Test step too high
        invalidStep = 128
        assertValidationError(
            try trig.validateValue(&invalidStep, forKey: "step"),
            expectedError: .invalidValue("Trig step must be between 0 and 127")
        )
        
        // Test valid steps
        for validStep: Int16 in [0, 15, 63, 127] {
            var step = validStep
            XCTAssertNoThrow(try trig.validateValue(&step, forKey: "step"))
        }
    }
    
    func testTrigNoteValidation() throws {
        let (_, _, track, _) = try createTestHierarchy()
        let trig = Trig(context: testContext)
        trig.track = track
        trig.pattern = track.pattern
        
        // Test note too low
        var invalidNote: Int16 = -1
        assertValidationError(
            try trig.validateValue(&invalidNote, forKey: "note"),
            expectedError: .invalidValue("Trig note must be between 0 and 127 (MIDI range)")
        )
        
        // Test note too high
        invalidNote = 128
        assertValidationError(
            try trig.validateValue(&invalidNote, forKey: "note"),
            expectedError: .invalidValue("Trig note must be between 0 and 127 (MIDI range)")
        )
        
        // Test valid notes
        for validNote: Int16 in [0, 60, 127] {
            var note = validNote
            XCTAssertNoThrow(try trig.validateValue(&note, forKey: "note"))
        }
    }
    
    func testTrigVelocityValidation() throws {
        let (_, _, track, _) = try createTestHierarchy()
        let trig = Trig(context: testContext)
        trig.track = track
        trig.pattern = track.pattern
        
        // Test velocity too low
        var invalidVelocity: Int16 = 0
        assertValidationError(
            try trig.validateValue(&invalidVelocity, forKey: "velocity"),
            expectedError: .invalidValue("Trig velocity must be between 1 and 127")
        )
        
        // Test velocity too high
        invalidVelocity = 128
        assertValidationError(
            try trig.validateValue(&invalidVelocity, forKey: "velocity"),
            expectedError: .invalidValue("Trig velocity must be between 1 and 127")
        )
        
        // Test valid velocities
        for validVelocity: Int16 in [1, 64, 100, 127] {
            var velocity = validVelocity
            XCTAssertNoThrow(try trig.validateValue(&velocity, forKey: "velocity"))
        }
    }
    
    // MARK: - Kit Validation Tests
    
    func testKitNameValidation() throws {
        let kit = Kit(context: testContext)
        
        // Test empty name validation
        kit.name = ""
        assertValidationError(
            try kit.validateValue(&kit.name, forKey: "name"),
            expectedError: .invalidName("Kit name cannot be empty")
        )
        
        // Test valid name
        kit.name = "Valid Kit"
        XCTAssertNoThrow(try kit.validateValue(&kit.name, forKey: "name"))
    }
    
    func testKitSoundFilesValidation() throws {
        let kit = Kit(context: testContext)
        kit.name = "Test Kit"
        
        // Test empty sound files array (should be valid)
        kit.soundFiles = []
        XCTAssertNoThrow(try kit.validateValue(&kit.soundFiles, forKey: "soundFiles"))
        
        // Test valid sound files
        kit.soundFiles = ["kick.wav", "snare.wav", "hihat.wav"]
        XCTAssertNoThrow(try kit.validateValue(&kit.soundFiles, forKey: "soundFiles"))
    }
    
    // MARK: - Preset Validation Tests
    
    func testPresetNameValidation() throws {
        let project = createTestProject()
        let preset = Preset(context: testContext)
        preset.project = project
        
        // Test empty name validation
        preset.name = ""
        assertValidationError(
            try preset.validateValue(&preset.name, forKey: "name"),
            expectedError: .invalidName("Preset name cannot be empty")
        )
        
        // Test valid name
        preset.name = "Valid Preset"
        XCTAssertNoThrow(try preset.validateValue(&preset.name, forKey: "name"))
    }
    
    func testPresetCategoryValidation() throws {
        let project = createTestProject()
        let preset = Preset(context: testContext)
        preset.project = project
        preset.name = "Test Preset"
        
        // Test invalid category
        preset.category = "INVALID_CATEGORY"
        assertValidationError(
            try preset.validateValue(&preset.category, forKey: "category"),
            expectedError: .invalidValue("Preset category must be one of: FM TONE, FM DRUM, WAVETONE, SWARMER")
        )
        
        // Test valid categories
        let validCategories = ["FM TONE", "FM DRUM", "WAVETONE", "SWARMER"]
        for category in validCategories {
            preset.category = category
            XCTAssertNoThrow(try preset.validateValue(&preset.category, forKey: "category"))
        }
    }
}

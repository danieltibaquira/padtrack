# Dockerfile for CI Environment Replication
# This creates a containerized environment that matches CI build conditions

FROM swift:5.10-ubuntu22.04

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    libxml2-dev \
    libssl-dev \
    zlib1g-dev \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy package files for dependency resolution
COPY Package.swift Package.resolved* ./

# Resolve dependencies
RUN swift package resolve

# Copy source code
COPY Sources/ Sources/
COPY Tests/ Tests/

# Set build environment variables
ENV CI=true
ENV SWIFT_PACKAGE_MANAGER=true
ENV LINUX_BUILD=true

# Create build script
RUN echo '#!/bin/bash\n\
set -e\n\
echo "🏗️ Starting CI build in container..."\n\
\n\
# Clean build\n\
swift package clean\n\
\n\
# Build all targets\n\
echo "Building all targets..."\n\
swift build --configuration debug\n\
\n\
# Run tests\n\
echo "Running tests..."\n\
swift test --configuration debug\n\
\n\
# Build release configuration\n\
echo "Building release configuration..."\n\
swift build --configuration release\n\
\n\
echo "✅ CI build completed successfully"\n\
' > /usr/local/bin/ci-build.sh && chmod +x /usr/local/bin/ci-build.sh

# Default command
CMD ["ci-build.sh"]